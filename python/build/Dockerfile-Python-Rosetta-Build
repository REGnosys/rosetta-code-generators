FROM python:3.10-alpine
RUN apk add --no-cache bash
RUN apk update
RUN mkdir /opt/isda-cdm-code-gen 
WORKDIR /opt/isda-cdm-code-gen 
COPY src/main/resources/runtime/rosetta_runtime-1.0.0-py3-none-any.whl rosetta_runtime-1.0.0-py3-none-any.whl
COPY target/python/src /opt/isda-cdm-code-gen/python/src
COPY target/python/pyproject.toml /opt/isda-cdm-code-gen/python/pyproject.toml
COPY test/serialization/ /opt/isda-cdm-code-gen/test/serialization
RUN python3 -m pip install pydantic
RUN python3 -m pip install jsonpickle
RUN python3 -m pip install rosetta_runtime-1.0.0-py3-none-any.whl
WORKDIR /opt/isda-cdm-code-gen/python
RUN python3 -m pip wheel --no-deps --only-binary :all: .
# setup test environment
RUN python3 -m pip install python_cdm-3.3.2-py3-none-any.whl
RUN python3 -m pip install pytest
WORKDIR /opt/isda-cdm-code-gen/test/
CMD python3 -m pytest

# from root directory
# docker build -f ./build/Dockerfile-Python-Rosetta-Build -t python-gen .
# to run 
# docker run -t python-gen
# to run interactively
# docker run -i -t python-gen bash              
# mimick codefresh
# docker run --rm -it --mount type=bind,source=/Users/dls/projects/common-domain-model/rosetta-source/target/classes/cdm/python,target=/mnt --entrypoint sh python:3.10-alpine